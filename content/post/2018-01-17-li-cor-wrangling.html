---
title: Parsing photosynthesis data from a LI-COR LI-6400 in R
author: Eric R. Scott
date: '2018-01-17'
slug: li-cor-wrangling
categories:
  - Research
tags:
  - R
  - LI-COR
  - Data-wrangling
  - Regexp
projects: ["bace-tea"]
draft: true
---



<p>The <a href="https://www.licor.com/env/products/photosynthesis/LI-6400XT/">LI-6400XT</a> is a portable device used to measure photosynthesis in plant leaves. The interface is a simple green and black text screen with a keyboard and some buttons. As you take measurements, they are recorded by the device. In order to keep track of which measurments go with which plants (or experimental treatments), there is an “add remark” option where you can enter sample information before taking measurements.</p>
<p>When the data are exported, you get a series of .xls files and a plain text file. Both of these have some problems that you’ll have to deal with if you want to read the data into R and use it for statistical analysis or generating reports.</p>
<div class="figure"><span id="fig:excel"></span>
<img src="/img/licor_excel.png" alt="Excel nightmare or text nightmare? Pick your poison." width="90%" />
<p class="caption">
Figure 1: Excel nightmare or text nightmare? Pick your poison.
</p>
</div>
<p>One obvious problem is all the header information. Fortunatly, it’s mostly just information about the instrument configuration that we don’t need and we could deal with it by just skipping some number of rows when reading the file in. However there is also the problem of the way the remarks are handled. Instead of being in their own column, they appear in the <code>HHMMSS</code> column! And to indicate that the row is a remark, instead of giving it an observation number in <code>Obs</code>, it just says “Remark =”. A less obvious problem is the weird row of “in”s and “out”s under the header. I’m honestly not sure what this is, but it’s in the way, so it’s gotta go.</p>
<p>Another problem that you can’t see in Fig. 1 is that I’ve done my measurments in several bouts. This produced two .xls files and a text file with header junk inbetween my two sets of measurements. At this point I had to choose between reading in the .xls files with <code>read_xls()</code> from the <code>readxl</code> package and doing some wrangling from there, or to deal with the text file, which would surely include some regular expression headaches.</p>
<p>For some unknown reason, <code>read_xls()</code> didn’t work on these files, and I had to open them in Excel, then save them as .xlsx files and use <code>read_xlsx()</code> to get them into R. For the sake of full automatedness, I’m going to work through the text file example here.</p>
<div id="tidying-up-raw-text" class="section level2">
<h2>Tidying up raw text</h2>
<p>My approach is to read in the raw text, tidy it up, then use <code>read_tsv()</code> to get a list of data frames. I’ll be using functions from <code>stringr</code> to do the text tidying, and functions from various <code>tidyverse</code> packages to bring it all together into a coherent data frame.</p>
<pre class="r"><code>library(tidyverse)
library(stringr)</code></pre>
<pre class="r"><code>text.raw &lt;- read_file(&quot;licor.txt&quot;)</code></pre>
<p>Scrolling through the text a little reveals that, conveniently, the line $STARTOFDATA$ appears between the header information and the start of the actual data. The headers themselves always begin with “OPEN” followed by a date. I create regular expression patterns for these and use them to split the raw text file first into separate bouts of measurements, then into headers and data, discarding the headers.</p>
<pre class="r"><code>header_pattern &lt;- &quot;\&quot;OPEN \\d\\.\\d\\.\\d&quot;
data_pattern &lt;- &quot;\\$STARTOFDATA\\$&quot;

#splits into individual bouts
raw_split &lt;- str_split(text.raw, header_pattern, simplify = TRUE)

#splits further to separate headers from actual data
raw_split2 &lt;- str_split(raw_split, data_pattern, simplify = FALSE)

str(raw_split2)</code></pre>
<pre><code>## List of 3
##  $ : chr &quot;&quot;
##  $ : chr [1:2] &quot;\&quot;\n\&quot;Fri Aug 25 2017 08:29:30\&quot;\n&lt;open&gt;&lt;version&gt;\&quot;6.3.4\&quot;&lt;/version&gt;&lt;/open&gt;\n&lt;open&gt;&lt;configfile&gt;\&quot;/User/Configs/&quot;| __truncated__ &quot;\n\&quot;Obs\&quot;\t\&quot;HHMMSS\&quot;\t\&quot;FTime\&quot;\t\&quot;EBal?\&quot;\t\&quot;Photo\&quot;\t\&quot;Cond\&quot;\t\&quot;Ci\&quot;\t\&quot;Trmmol\&quot;\t\&quot;VpdL\&quot;\t\&quot;CTleaf\&quot;\t\&quot;A&quot;| __truncated__
##  $ : chr [1:2] &quot;\&quot;\n\&quot;Fri Aug 25 2017 10:32:44\&quot;\n&lt;open&gt;&lt;version&gt;\&quot;6.3.4\&quot;&lt;/version&gt;&lt;/open&gt;\n&lt;open&gt;&lt;configfile&gt;\&quot;/User/Configs/&quot;| __truncated__ &quot;\n\&quot;Obs\&quot;\t\&quot;HHMMSS\&quot;\t\&quot;FTime\&quot;\t\&quot;EBal?\&quot;\t\&quot;Photo\&quot;\t\&quot;Cond\&quot;\t\&quot;Ci\&quot;\t\&quot;Trmmol\&quot;\t\&quot;VpdL\&quot;\t\&quot;CTleaf\&quot;\t\&quot;A&quot;| __truncated__</code></pre>
<p>It’s a little hard to see with <code>str()</code> (try <code>View(raw_split2)</code>), but now there is a list of 3 elements, where each element is a vector of strings. The first element contains nothing, the other elements contain two strings—one is the header, the other is the data. Let’s get rid of the headers and the empty list element.</p>
<pre class="r"><code>#extract just the second element, the actual data
raw_split3 &lt;- raw_split2 %&gt;%
  map(`[`, 2) %&gt;% #equivalent to doing raw_split2[[i]][2] for every element &quot;i&quot;
  flatten_chr() #converts to a vector

#remove empty elements
raw_split3 &lt;- raw_split3[!is.na(raw_split3)]</code></pre>
</div>
<div id="reading-in-our-cleaned-text-file" class="section level2">
<h2>Reading in our cleaned text file</h2>
<p>Then we can finally read in our cleaned text as a tab-separated (.tsv) file. Here I make use of <code>map()</code> from the <code>purrr</code> package to apply <code>read_tsv()</code> to every string in our raw text vector. <code>skip = 1</code> gets rid of that weird line of “in”s and “out”s.</p>
<pre class="r"><code>input &lt;- raw_split3 %&gt;%
  map(read_tsv, skip = 1)
input[[1]]</code></pre>
<pre><code>## # A tibble: 304 x 40
##                                    Obs   HHMMSS FTime `EBal?` Photo   Cond
##                                  &lt;chr&gt;   &lt;time&gt; &lt;dbl&gt;   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;
##  1    08:30:38 Lamp: ParIn -&gt;  500 uml       NA    NA      NA    NA     NA
##  2 08:32:37 CO2 Mixer: CO2R -&gt; 400 uml       NA    NA      NA    NA     NA
##  3    08:40:20 Lamp: ParIn -&gt;  500 uml       NA    NA      NA    NA     NA
##  4 08:40:20 CO2 Mixer: CO2R -&gt; 400 uml       NA    NA      NA    NA     NA
##  5               08:40:20 Coolers: Off       NA    NA      NA    NA     NA
##  6  08:40:20 Flow: Fixed -&gt; 500 umol/s       NA    NA      NA    NA     NA
##  7  08:42:11 Flow: Fixed -&gt; 500 umol/s       NA    NA      NA    NA     NA
##  8                      08:43:13 c 4 a       NA    NA      NA    NA     NA
##  9                                   1 08:43:53   932       0  6.62 0.0589
## 10                                   2 08:43:58   937       0  6.99 0.0594
## # ... with 294 more rows, and 34 more variables: Ci &lt;dbl&gt;, Trmmol &lt;dbl&gt;,
## #   VpdL &lt;dbl&gt;, CTleaf &lt;dbl&gt;, Area &lt;int&gt;, BLC_1 &lt;dbl&gt;, StmRat &lt;int&gt;,
## #   BLCond &lt;dbl&gt;, Tair &lt;dbl&gt;, Tleaf &lt;dbl&gt;, TBlk &lt;dbl&gt;, CO2R &lt;dbl&gt;,
## #   CO2S &lt;dbl&gt;, H2OR &lt;dbl&gt;, H2OS &lt;dbl&gt;, RH_R &lt;dbl&gt;, RH_S &lt;dbl&gt;,
## #   Flow &lt;dbl&gt;, PARi &lt;int&gt;, PARo &lt;int&gt;, Press &lt;dbl&gt;, CsMch &lt;dbl&gt;,
## #   HsMch &lt;dbl&gt;, CsMchSD &lt;dbl&gt;, HsMchSD &lt;dbl&gt;, CrMchSD &lt;dbl&gt;,
## #   HrMchSD &lt;dbl&gt;, StableF &lt;dbl&gt;, BLCslope &lt;dbl&gt;, BLCoffst &lt;dbl&gt;,
## #   f_parin &lt;dbl&gt;, f_parout &lt;dbl&gt;, alphaK &lt;dbl&gt;, Status &lt;int&gt;</code></pre>
</div>
<div id="extracting-useful-remarks" class="section level2">
<h2>Extracting useful remarks</h2>
</div>
