<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.31.1" />
  <meta name="author" content="Eric R. Scott">
  <meta name="description" content="PhD Candidate in Biology">

  
  <link rel="alternate" hreflang="en-us" href="http://ericrscott.com/2017/12/24/leafhopper-fiji/">

  
  


  

  
  
  
  
    
  
  
    
    
      
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
      
    
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.1/css/academicons.min.css" integrity="sha512-NThgw3XKQ1absAahW6to7Ey42uycrVvfNfyjqcFNgCmOCQ5AR4AO0SiXrN+8ZtYeappp56lk1WtvjVmEa+VR6A==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
  
  
  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Montserrat:400,700%7cRoboto:400,400italic,700%7cRoboto&#43;Mono">
  
  <link rel="stylesheet" href="/styles.css">
  

  

  
  <link rel="alternate" href="http://ericrscott.com/index.xml" type="application/rss+xml" title="Eric R. Scott">
  <link rel="feed" href="http://ericrscott.com/index.xml" type="application/rss+xml" title="Eric R. Scott">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="http://ericrscott.com/2017/12/24/leafhopper-fiji/">

  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@leafyericscott">
  <meta property="twitter:creator" content="@leafyericscott">
  
  <meta property="og:site_name" content="Eric R. Scott">
  <meta property="og:url" content="http://ericrscott.com/2017/12/24/leafhopper-fiji/">
  <meta property="og:title" content="Quantifying leafhopper damage with automated supervised classification | Eric R. Scott">
  <meta property="og:description" content=""><meta property="og:image" content="http://ericrscott.com/img/headers/analyzed%20leaf%20header.png">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2017-12-24T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2017-12-24T00:00:00&#43;00:00">
  

  

  <title>Quantifying leafhopper damage with automated supervised classification | Eric R. Scott</title>

</head>
<body id="top" data-spy="scroll" data-target="#toc" data-offset="71" >

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a class="navbar-brand" href="/"><img src="/img/leaf-logo.png" alt="Eric R. Scott"></a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      
      <ul class="nav navbar-nav navbar-right">
        

        

        
          
        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#projects">
            
            <span>Research Projects</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#publications_selected">
            
            <span>Publications &amp; Presentations</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#blogs">
            
            <span>Outreach</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#teaching">
            
            <span>Teaching</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#posts">
            
            <span>Blog</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#contact">
            
            <span>Contact</span>
            
          </a>
        </li>

        
        
      

      
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  
<div class="article-header">
  <img src="/img/headers/analyzed%20leaf%20header.png" class="article-banner" itemprop="image">
  
</div>



  <div class="article-container">
    <div class="article-inner">
      <h1 itemprop="name">Quantifying leafhopper damage with automated supervised classification</h1>

      

<div class="article-metadata">

  <span class="article-date">
    
    <time datetime="2017-12-24 00:00:00 &#43;0000 UTC" itemprop="datePublished">
      Dec 24, 2017
    </time>
  </span>

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    7 min read
  </span>
  

  
  
  <span class="middot-divider"></span>
  <a href="http://ericrscott.com/2017/12/24/leafhopper-fiji/#disqus_thread"></a>
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fa fa-folder"></i>
    
    <a href="/categories/research">Research</a
    >
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Quantifying%20leafhopper%20damage%20with%20automated%20supervised%20classification&amp;url=http%3a%2f%2fericrscott.com%2f2017%2f12%2f24%2fleafhopper-fiji%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=http%3a%2f%2fericrscott.com%2f2017%2f12%2f24%2fleafhopper-fiji%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2fericrscott.com%2f2017%2f12%2f24%2fleafhopper-fiji%2f&amp;title=Quantifying%20leafhopper%20damage%20with%20automated%20supervised%20classification"
         target="_blank" rel="noopener">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=http%3a%2f%2fericrscott.com%2f2017%2f12%2f24%2fleafhopper-fiji%2f&amp;title=Quantifying%20leafhopper%20damage%20with%20automated%20supervised%20classification"
         target="_blank" rel="noopener">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Quantifying%20leafhopper%20damage%20with%20automated%20supervised%20classification&amp;body=http%3a%2f%2fericrscott.com%2f2017%2f12%2f24%2fleafhopper-fiji%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


      <div class="article-style" itemprop="articleBody">
        <p>As part of my fieldwork in China, I collected harvested tea leaves that were damaged by the tea green leafhopper. I want to quantify the amount of leafhopper damage for each harvest. I was able to find several solutions for quantifying holes in leaves or even damage to leaf margins, but typical leafhopper damage is just tiny brown spots on the undersides of leaves. I did find some tutorials on using <a href="http://imagej.net/Welcome">ImageJ</a> to analyze diseased area on leaves, but found that the leafhopper damage spots were too small and too similar in color to undamaged leaves for these tools to work reliably and be automated.</p>
<div class="figure" style="text-align: left"><span id="fig:leaf-fig"></span>
<img src="/img/damaged leaf.png" alt="Typical leafhopper damage" width="60%" />
<p class="caption">
Figure 1: Typical leafhopper damage
</p>
</div>
<p>Last year I piloted a method to quantify leafhopper damage on scanned images of tea leaves with the help of a Tufts undergraduate, Maxwell Turpin. We ended up getting the most success using a supervised classification algorithm implemented by the <a href="https://imagej.net/Trainable_Weka_Segmentation">trainable WEKA segmentation</a> plugin in <a href="https://fiji.sc/">FIJI</a> (which stands for “FIJI is just Image J”). This semester, another Tufts undergraduate, Michelle Mu, worked on refining this approach, automating it, and applying it to the hundreds of images I obtained over the summer as part of my research.</p>
<div id="supervised-pixel-classification" class="section level2">
<h2>Supervised pixel classification</h2>
<p>Just to clarify, my goal here is not image classification—that is, I’m not trying to classify leaves into categories like “undamaged”, “medium damaged”, “high damage”, but rather trying to classify individual pixels in the image as being damaged or undamaged leaf tissue (or background).</p>
<p>In short, after selecting some pixels representative of damaged leaf, undamaged leaf, and background (regions of interest, or ROIs), the WEKA plugin trains a random forest algorithm using data from various transformations of the pixels in the ROIs. Then, I can apply the algorithm to other images and extract data in the form of numbers of pixels classified in each category.</p>
<div class="figure"><span id="fig:example-result"></span>
<img src="/img/analyzed leaf.png" alt="example results of WEKA classification" width="60%" />
<p class="caption">
Figure 2: example results of WEKA classification
</p>
</div>
</div>
<div id="weka-segmentation-tips" class="section level2">
<h2>WEKA segmentation tips</h2>
<p>The <a href="https://imagej.net/Trainable_Weka_Segmentation">documentation</a> on the WEKA segmentation plugin is fairly detailed, so I won’t go into great detail on how to use it, rather focus on some things I learned specific to this project.</p>
<div id="creating-a-training-stack" class="section level3">
<h3>Creating a training stack</h3>
<p>I had hundreds of images to classify, so obviously it made sense to train a classifier on a subset of leaves. We started by taking my leaf scans, which contained dozens of leaves, and making images of individual leaves. You can do this in any number of image manipulation software, but we found it easiest using Preview, the default image and PDF viewer on OS X. You just select a leaf with the rectangle selection tool, copy with cmd + c, and create a new image with cmd + n, then save with cmd + s.</p>
<p>We then chose a random subset of 15 leaves to use as a training set. Why 15? At the time, we were using a regular desktop computer with 8 GB of RAM, and using the WEKA plugin with an image stack any larger than that caused it to crash. Fortunately, because the leaves were all scanned in a uniform way and leaf color didn’t vary too much, 15 leaves was suitable for a training set. If you have more RAM at your disposal, feel free to train on more leaves.</p>
</div>
<div id="training-and-applying-a-classifier" class="section level3">
<h3>Training and applying a classifier</h3>
<p>We trained the classifier on three classes, background, damaged leaf, and undamaged leaf. For background and undamaged leaf, we found it was really important to focus on leaf edges, making sure to include shadows in the background class and lighter green leaf margins in the undamaged class. Without doing this, the classifier would consistently mis-classify shadows and edges as either damaged or background, respectively. This was also an iterative process and took several rounds of selecting ROIs, training a classifier, viewing results, and adding more ROIs. Once we were satisfied with our classifier, we saved it and applied it to all of our images in stacks of 20 on a computer with 32 GB of RAM. The results created by the WEKA plugin are stacks of three color images (because we used 3 classes). Getting numerical results turned out to be another problem.</p>
<div class="figure"><span id="fig:screenshot"></span>
<img src="/img/WEKA screenshot.png" alt="WEKA segmentation window with ROIs selected"  />
<p class="caption">
Figure 3: WEKA segmentation window with ROIs selected
</p>
</div>
</div>
<div id="exporting-results" class="section level3">
<h3>Exporting results</h3>
<p>Exporting results in a numeric format turned out to be a lot more difficult than we thought it would. The manual way of doing this through the FIJI menus is <em>Analyze &gt; Histogram</em> which opens a histogram window, then clicking “list” to get a results window with the number of pixels in each class for that image, then copying and pasting into Excel. This was far too labor intensive and error-prone to be appropriate for hundreds of images. We needed a better way, which led us to FIJI macros.</p>
<p>Building a macro turned out to be relatively painless, even though neither Michelle nor I had any experience coding in any language other than R. Through a combination of forum posts and using the documentation for the <a href="http://imagej.net/developer/macro/functions.html">ImageJ macro language</a> as a reference, we were able to create a macro that opens results stacks (three-color images) and exports a text file containing the number of pixels in each class for each image in the stack.</p>
<pre><code>//ImageJ macro for exporting numerical results from classified image stacks
inpath = getDirectory(&quot;Analyzed Stacks&quot;);
File.makeDirectory(inpath + &quot;//Results//&quot;);
//outpath = getDirectory(&quot;Results&quot;);
//for some reason using getDirectory() twice screws things up.
//My solution is to just create a results folder in the folder with the analyzed stacks
//But then you get an error at the end when the script tries to open that folder.
files = getFileList(inpath);
for(j = 0; j &lt; lengthOf(files); j++){
    open(files[j]);
    title = getTitle();
    for (n = 1; n &lt;= nSlices(); n++) { //loop through slices
        showProgress(n, nSlices); //this just adds a progress bar
        setSlice(n); //set which slice
        getStatistics(area, mean, min, max, std, histogram); //this gets the number of pixels
        for (i=0; i&lt;histogram.length; i++) {
            setResult(&quot;Value&quot;, i, i);
            setResult(&quot;Leaf.&quot; + n, i, histogram[i]); //adds a column for each slice called &quot;Count[slicenumber]&quot;
        }   
    saveAs(&quot;results&quot;, inpath + &quot;//Results//&quot; + title + &quot;.txt&quot;); //saves results table as text file
    }
    close();
    run(&quot;Clear Results&quot;);
}</code></pre>
</div>
<div id="importing-results" class="section level3">
<h3>Importing Results</h3>
<p>The results files then get read into R and tidied using a relatively simple script.</p>
<pre class="r"><code>#packages you will need
library(readr)
library(dplyr)
library(tidyr)
library(stringr)

#Get the filenames of all the results files
filenames &lt;- list.files(&quot;Results/&quot;) #might need to change path

#Create paths to those files
filepaths &lt;- paste0(&quot;Results/&quot;, filenames)

#make a list to eventually contain all the data files.  
raw.list &lt;- as.list(filenames)
names(raw.list) &lt;- filenames
raw.list

#for loop for reading in every file into an element of the list.  There is probably a faster way to do this with purrr::map
for(i in 1:length(filenames)){   #loop through all files
  raw.list[[i]] &lt;- read_tsv(filepaths[i])[1:2, -1] #read only the first two rows and NOT the first column into the list
}
raw.list #now contains multiple data frames.</code></pre>
<p>At this point, we have created a list of data frames, one for each image stack. Since our image stacks were split up just to make analysis possible with limited RAM, we want to merge the results back together now.</p>
<p>I also couldn’t figure out how to rename the classes in the Image J macro (they appear as numeric labels “0”, “1”, and “2”), so we took this opportunity to rename them in our R script.</p>
<pre class="r"><code>raw.data &lt;- raw.list %&gt;%
  bind_rows(.id = &quot;File&quot;) %&gt;% 
  mutate(Value = ifelse(Value == 0, &quot;damaged&quot;, &quot;undamaged&quot;) %&gt;% as.factor()) %&gt;% 
  #converts 0&#39;s to &quot;damaged&quot; and anything else to &quot;undamaged&quot;, then converts Value to a factor
  rename(Type = &quot;Value&quot;)
  #renames the &quot;Value&quot; column &quot;Type&quot;

raw.data.2 &lt;- raw.data %&gt;% 
  gather(-File, -Type, key = LeafID, value = Pixels) %&gt;%  #gathers all the data into three columns
  spread(key = Type, value = Pixels)</code></pre>
<p>And finished! With all the image stacks analyzed using our classifier, numeric results exported using our custom macro, and then read into R and tidied using our R script, we have data ready for statistical analysis!</p>
</div>
</div>

      </div>

      


<div class="article-tags">
  
  <a class="btn btn-primary btn-outline" href="/tags/fiji">FIJI</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/imagej">ImageJ</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/tea">tea</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/plant-defense">plant-defense</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/r">R</a>
  
</div>



    </div>
  </div>

</article>



<div class="article-container article-widget">
  <div class="hr-light"></div>
  <h3>Related</h3>
  <ul>
    
    <li><a href="/project/climate-leafhopper-quality/">Climate Effects on Bug-Bitten Tea</a></li>
    
    <li><a href="/project/bace-tea/">Drought and plant response to herbivory</a></li>
    
    <li><a href="/talk/tufts-gsc/">Can Insect Damage Improve Tea Quality In a Changing Climate?</a></li>
    
    <li><a href="/project/co2-herbivory/">Elevated CO2 and plant response to herbivory</a></li>
    
    <li><a href="/2017/12/19/making-a-website-in-rstudio/">Making a website in RStudio</a></li>
    
  </ul>
</div>




<div class="article-container">
  
<section id="comments">
  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "ericrscott" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2017 Eric R. Scott &middot; 

      Powered by the
      <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
      <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close btn-large" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Cite</h4>
      </div>
      <div>
        <pre><code class="modal-body tex"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-primary btn-outline js-copy-cite" href="#" target="_blank">
          <i class="fa fa-copy"></i> Copy
        </a>
        <a class="btn btn-primary btn-outline js-download-cite" href="#" target="_blank">
          <i class="fa fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    
    <script id="dsq-count-scr" src="//ericrscott.disqus.com/count.js" async></script>
    

    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha512-3P8rXCuGJdNZOnUx/03c1jOTnMn3rP63nBip5gOP2qmUh5YAdVAvFZ1E+QLZZbC1rtMrQb+mah3AfYW11RUrWA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
    
    
    <script src="/js/hugo-academic.js"></script>
    

    
    
      
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
      

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    

  </body>
</html>

